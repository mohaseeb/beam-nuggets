

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>beam_nuggets.io.relational_db_api &mdash; beam-nuggets 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> beam-nuggets
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started.html#usage">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../beam_nuggets.html">beam_nuggets package</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/mohaseeb/beam-nuggets">beam-nuggets on Github</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">beam-nuggets</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>beam_nuggets.io.relational_db_api</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for beam_nuggets.io.relational_db_api</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Wrapper of SqlAlchemy code used for reading from and writing to databases&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">create_engine</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span>
    <span class="n">Integer</span><span class="p">,</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="n">Float</span><span class="p">,</span>
    <span class="n">Boolean</span><span class="p">,</span>
    <span class="n">DateTime</span><span class="p">,</span>
    <span class="n">Date</span><span class="p">,</span>
    <span class="n">insert</span> <span class="k">as</span> <span class="n">generic_insert</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.mysql</span> <span class="k">import</span> <span class="n">insert</span> <span class="k">as</span> <span class="n">mysql_insert</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="k">import</span> <span class="n">insert</span> <span class="k">as</span> <span class="n">postgres_insert</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine.url</span> <span class="k">import</span> <span class="n">URL</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_utils</span> <span class="k">import</span> <span class="n">database_exists</span><span class="p">,</span> <span class="n">create_database</span>


<div class="viewcode-block" id="SourceConfiguration"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.SourceConfiguration">[docs]</a><span class="k">class</span> <span class="nc">SourceConfiguration</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Holds parameters for accessing a database.</span>

<span class="sd">    User to pass database access parameters to</span>
<span class="sd">    :class:`~beam_nuggets.io.relational_db_api.SqlAlchemyDB`.</span>

<span class="sd">    ``SourceConfiguration.url`` provides the database url used by SqlAlchemy to</span>
<span class="sd">    connect to the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        drivername (str): name of the database backend. It specifies the</span>
<span class="sd">            target database type and the driver (DBAPI) used</span>
<span class="sd">            by SqlAlchemy to communicate with database. The following</span>
<span class="sd">            drivernames are supported by and tested on beam-nuggets:</span>
<span class="sd">              - postgresql+pg8000: for PostgreSQL (pg8000 is the DB driver).</span>
<span class="sd">              - mysql+pymysql: for MySQL.</span>
<span class="sd">              - sqlite: for SQLite.</span>
<span class="sd">            Additional drivers can be used after installing their</span>
<span class="sd">            corresponding python libraries. Refer to `SqlAlchemy dialects`_</span>
<span class="sd">            for more information on the supported databases and the</span>
<span class="sd">            corresponding drivers.</span>
<span class="sd">        host (str): database host name or IP.</span>
<span class="sd">        port (int): database port number.</span>
<span class="sd">        database (str): database name.</span>
<span class="sd">        username (str): database username.</span>
<span class="sd">        password (str): database password.</span>
<span class="sd">        create_if_missing (bool): If set to True, it instructs to create a</span>
<span class="sd">            missing database before writing to it.</span>

<span class="sd">    Examples:</span>
<span class="sd">        MySQL database ::</span>

<span class="sd">            from beam_nuggets.io import relational_db</span>
<span class="sd">            src_cnf = relational_db.SourceConfiguration(</span>
<span class="sd">                drivername=&#39;mysql+pymysql&#39;,</span>
<span class="sd">                host=&#39;localhost&#39;,</span>
<span class="sd">                port=37311,</span>
<span class="sd">                username=&#39;root&#39;,</span>
<span class="sd">                database=&#39;test&#39;,</span>
<span class="sd">                create_if_missing=True,</span>
<span class="sd">            )</span>
<span class="sd">            print(src_cnf.url)</span>
<span class="sd">            # mysql+pymysql://root@localhost:37311/test</span>

<span class="sd">        PostgreSQL database ::</span>

<span class="sd">            from beam_nuggets.io import relational_db</span>
<span class="sd">            src_cnf = relational_db.SourceConfiguration(</span>
<span class="sd">                drivername=&#39;postgresql&#39;,</span>
<span class="sd">                host=&#39;localhost&#39;,</span>
<span class="sd">                port=42139,</span>
<span class="sd">                username=&#39;postgres&#39;,</span>
<span class="sd">                password=&#39;pass&#39;,</span>
<span class="sd">                database=&#39;test&#39;</span>
<span class="sd">            )</span>
<span class="sd">            print(src_cnf.url)</span>
<span class="sd">            # postgresql://postgres:pass@localhost:42139/test</span>

<span class="sd">        SQLite database ::</span>

<span class="sd">            from beam_nuggets.io import relational_db</span>
<span class="sd">            src_cnf = relational_db.SourceConfiguration(</span>
<span class="sd">                drivername=&#39;sqlite&#39;,</span>
<span class="sd">                database=&#39;/tmp/test_db.sqlite&#39;</span>
<span class="sd">            )</span>
<span class="sd">            print(src_cnf.url)</span>
<span class="sd">            # sqlite:////tmp/test_db.sqlite</span>

<span class="sd">    .. _SqlAlchemy dialects: https://docs.sqlalchemy.org/en/latest/dialects/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">drivername</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">create_if_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">URL</span><span class="p">(</span>
            <span class="n">drivername</span><span class="o">=</span><span class="n">drivername</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="n">database</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_if_missing</span> <span class="o">=</span> <span class="n">create_if_missing</span></div>


<div class="viewcode-block" id="TableConfiguration"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.TableConfiguration">[docs]</a><span class="k">class</span> <span class="nc">TableConfiguration</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Holds parameters for a database table.</span>
<span class="sd">    Used to pass table parameters to :class:`SqlAlchemyDB`.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): the table name.</span>
<span class="sd">        create_insert_f (function): a function that takes as input an</span>
<span class="sd">            SqlAlchemy table and a row record, and returns an statement for</span>
<span class="sd">            inserting the record into the table. The function doesn&#39;t</span>
<span class="sd">            execute the insert statement. If not specified, the following</span>
<span class="sd">            default implementations are used:</span>
<span class="sd">              - :func:`create_upsert_mysql` for MySQL tables.</span>
<span class="sd">              - :func:`create_upsert_postgres` for PostgreSQL tables.</span>
<span class="sd">              - :func:`create_insert` for other databases.</span>
<span class="sd">            As a mechanism to recover from failures, beam runners will</span>
<span class="sd">            attempt to apply a transform multiple times on the same data;</span>
<span class="sd">            because of that it is recommended to implement idempotent writes</span>
<span class="sd">            (e.g. :func:`create_upsert_mysql` and</span>
<span class="sd">            :func:`create_upsert_postgres`)</span>
<span class="sd">            to avoid data inconsistency issues arising from this beam behavior.</span>
<span class="sd">            The function has the following signature:</span>
<span class="sd">            (``sqlalchemy.sql.schema.Table``, ``dict``) -&gt;</span>
<span class="sd">            ``sqlalchemy.sql.dml.Insert``.</span>
<span class="sd">        create_if_missing (bool): if set to True and the table is missing</span>
<span class="sd">            :class:`SqlAlchemyDB` will create the table. See below notes on new</span>
<span class="sd">            table creation. See below note how this is used when creating</span>
<span class="sd">            new tables.</span>
<span class="sd">        primary_key_columns (list): list of column names to be used as</span>
<span class="sd">            primary key (if multiple columns are specified, a composite key</span>
<span class="sd">            is created), when creating the table. See below notes on new table</span>
<span class="sd">            creation.</span>
<span class="sd">        define_table_f (function): A function for defining an SqlAlchemy</span>
<span class="sd">            table (the function doesn&#39;t create the table); the definition is</span>
<span class="sd">            used when creating the table. The function has the following</span>
<span class="sd">            signature: (``Sqlalchemy.Metadata``) -&gt; ``sqlalchemy.Table``. See</span>
<span class="sd">            below notes on how this is used when creating missing tables.</span>
<span class="sd">            See this `define table tutorial`_ for how to implement the</span>
<span class="sd">            function.</span>

<span class="sd">    Notes:</span>
<span class="sd">        When attempting to write to a missing database table,</span>
<span class="sd">        :class:`SqlAlchemyDB` will handle the situation based on the values</span>
<span class="sd">        ``create_if_missing``, ``primary_key_columns`` and ``define_table_f``</span>
<span class="sd">        of the passed :class:`TableConfiguration`, as follows:</span>
<span class="sd">          - If the table is missing and ``create_if_missing`` is set to</span>
<span class="sd">            False (default), :class:`SqlAlchemyDB` will raise an exception.</span>
<span class="sd">          - Only when the target table is missing and ``create_if_missing``</span>
<span class="sd">            is set to True, table creation is attempted. This is the assumed</span>
<span class="sd">            state for all the following cases.</span>
<span class="sd">          - If ``define_table_f`` is specified, a new table will be created</span>
<span class="sd">            using the table definition returned by ``define_table_f``,</span>
<span class="sd">            irrespective of ``primary_key_columns``.</span>
<span class="sd">          - If ``primary_key_columns`` is specified and ``define_table_f``</span>
<span class="sd">            is None, a new table will be created using the columns specified</span>
<span class="sd">            in ``primary_key_columns`` as the primary key. The full column</span>
<span class="sd">            list and their types are inferred automatically using the first</span>
<span class="sd">            record to be written. See :func:`infer_db_type` for information on</span>
<span class="sd">            the how the database column types are inferred from the python</span>
<span class="sd">            types. If ``primary_key_columns`` is also None, an auto_increment</span>
<span class="sd">            Integer column will be created and used as primary key this is</span>
<span class="sd">            done as some databases require a primary key to be specified when</span>
<span class="sd">            creating tables.</span>

<span class="sd">    Examples:</span>
<span class="sd">        A configuration for creating the table if missing using the specified</span>
<span class="sd">        columns to create the primary key. ::</span>

<span class="sd">            from beam_nuggets.io import relational_db</span>

<span class="sd">            table_config = relational_db.TableConfiguration(</span>
<span class="sd">                name=&#39;students&#39;,</span>
<span class="sd">                create_if_missing=True,</span>
<span class="sd">                primary_key_columns=[&#39;id&#39;]</span>
<span class="sd">            )</span>


<span class="sd">        A configuration for creating the table if missing using the specified</span>
<span class="sd">        definition. ::</span>

<span class="sd">            from sqlalchemy import Table, Integer, String, Column</span>
<span class="sd">            from beam_nuggets.io import relational_db</span>

<span class="sd">            table_name = &#39;students&#39;</span>

<span class="sd">            def define_students_table(metadata):</span>
<span class="sd">                return Table(</span>
<span class="sd">                    table_name, metadata,</span>
<span class="sd">                    Column(ID, Integer, primary_key=True),</span>
<span class="sd">                    Column(NAME, String(100)),</span>
<span class="sd">                    Column(AGE, Integer)</span>
<span class="sd">                )</span>

<span class="sd">            table_config = relational_db.TableConfiguration(</span>
<span class="sd">                name=table_name,</span>
<span class="sd">                create_if_missing=True,</span>
<span class="sd">                define_table_f=define_students_table</span>
<span class="sd">            )</span>

<span class="sd">    .. _define table tutorial:</span>
<span class="sd">       https://docs.sqlalchemy.org/en/latest/core/tutorial.html#define-and</span>
<span class="sd">       -create-tables</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">define_table_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">create_if_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">primary_key_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">create_insert_f</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_table_f</span> <span class="o">=</span> <span class="n">define_table_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_if_missing</span> <span class="o">=</span> <span class="n">create_if_missing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key_column_names</span> <span class="o">=</span> <span class="n">primary_key_columns</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_insert_f</span> <span class="o">=</span> <span class="n">create_insert_f</span></div>


<div class="viewcode-block" id="SqlAlchemyDB"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.SqlAlchemyDB">[docs]</a><span class="k">class</span> <span class="nc">SqlAlchemyDB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides functionality to read and write from and to relational DBs.</span>
<span class="sd">    It uses SqlAlchemy.</span>

<span class="sd">    Args:</span>
<span class="sd">        source_config (SourceConfiguration): Information for accessing the</span>
<span class="sd">            target database.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">source_config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_SessionClass</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">create_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># will be set in self.start_session()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_name_to_table</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># tables metadata cache</span>

<div class="viewcode-block" id="SqlAlchemyDB.start_session"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.SqlAlchemyDB.start_session">[docs]</a>    <span class="k">def</span> <span class="nf">start_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">create_if_missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">create_if_missing</span>
        <span class="n">is_database_missing</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="ow">not</span> <span class="n">database_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">create_if_missing</span> <span class="ow">and</span> <span class="n">is_database_missing</span><span class="p">():</span>
            <span class="n">create_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SessionClass</span><span class="p">()</span></div>

<div class="viewcode-block" id="SqlAlchemyDB.close_session"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.SqlAlchemyDB.close_session">[docs]</a>    <span class="k">def</span> <span class="nf">close_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SqlAlchemyDB.read"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.SqlAlchemyDB.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_table_for_read</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">records</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">record</span></div>

<div class="viewcode-block" id="SqlAlchemyDB.query"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.SqlAlchemyDB.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_table_for_read</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">query_records</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">record</span></div>

<div class="viewcode-block" id="SqlAlchemyDB.write_record"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.SqlAlchemyDB.write_record">[docs]</a>    <span class="k">def</span> <span class="nf">write_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_config</span><span class="p">,</span> <span class="n">record_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a single record to the specified table.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_config (TableConfiguration): specifies the target table,</span>
<span class="sd">                 how data should inserted and how to create it if it was</span>
<span class="sd">                 missing. See :class:`TableConfiguration` notes on table</span>
<span class="sd">                 creation.</span>
<span class="sd">            record_dict (dict): the record to be written</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_table_for_write</span><span class="p">(</span><span class="n">table_config</span><span class="p">,</span> <span class="n">record_dict</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span>
            <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span>
            <span class="n">create_insert_f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_create_insert_f</span><span class="p">(</span><span class="n">table_config</span><span class="p">),</span>
            <span class="n">record_dict</span><span class="o">=</span><span class="n">record_dict</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_create_insert_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_config</span><span class="p">):</span>
        <span class="n">create_insert_f</span> <span class="o">=</span> <span class="n">table_config</span><span class="o">.</span><span class="n">create_insert_f</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">create_insert_f</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;postgresql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">drivername</span><span class="p">:</span>
                <span class="n">create_insert_f</span> <span class="o">=</span> <span class="n">create_upsert_postgres</span>
            <span class="k">elif</span> <span class="s1">&#39;mysql&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">drivername</span><span class="p">:</span>
                <span class="n">create_insert_f</span> <span class="o">=</span> <span class="n">create_upsert_mysql</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">create_insert_f</span> <span class="o">=</span> <span class="n">create_insert</span>
        <span class="k">return</span> <span class="n">create_insert_f</span>

    <span class="k">def</span> <span class="nf">_open_table_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_table</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">get_table_f</span><span class="o">=</span><span class="n">load_table</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open_table_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_config</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_table</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">table_config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">get_table_f</span><span class="o">=</span><span class="n">create_table</span><span class="p">,</span>
            <span class="n">table_config</span><span class="o">=</span><span class="n">table_config</span><span class="p">,</span>
            <span class="n">record</span><span class="o">=</span><span class="n">record</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">get_table_f</span><span class="p">,</span> <span class="o">**</span><span class="n">get_table_f_params</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_to_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name_to_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">get_table_f</span><span class="p">,</span> <span class="o">**</span><span class="n">get_table_f_params</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_to_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">table</span>

    <span class="k">def</span> <span class="nf">_get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">get_table_f</span><span class="p">,</span> <span class="o">**</span><span class="n">get_table_f_params</span><span class="p">):</span>
        <span class="n">table_class</span> <span class="o">=</span> <span class="n">get_table_f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">get_table_f_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_class</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">_Table</span><span class="p">(</span><span class="n">table_class</span><span class="o">=</span><span class="n">table_class</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SqlAlchemyDbException</span><span class="p">(</span><span class="s1">&#39;Failed to get table </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">table</span></div>


<div class="viewcode-block" id="SqlAlchemyDbException"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.SqlAlchemyDbException">[docs]</a><span class="k">class</span> <span class="nc">SqlAlchemyDbException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="k">class</span> <span class="nc">_Table</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_class</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Class</span> <span class="o">=</span> <span class="n">table_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_table</span> <span class="o">=</span> <span class="n">table_class</span><span class="o">.</span><span class="n">__table__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_names</span> <span class="o">=</span> <span class="n">get_column_names_from_table</span><span class="p">(</span><span class="n">table_class</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Class</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_db_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">query_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_db_record</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">mapper</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">create_insert_f</span><span class="p">,</span> <span class="n">record_dict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">create_insert_f</span><span class="p">(</span>
                <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlalchemy_table</span><span class="p">,</span>
                <span class="n">record</span><span class="o">=</span><span class="n">record_dict</span>
            <span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_stmt</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_to_db_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record_dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Class</span><span class="p">(</span><span class="o">**</span><span class="n">record_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_db_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_record</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">if</span> <span class="n">mapper</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db_record</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mapper</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db_record</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_names</span><span class="p">}</span>


<div class="viewcode-block" id="load_table"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.load_table">[docs]</a><span class="k">def</span> <span class="nf">load_table</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">table_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">bind</span>
    <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">has_table</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">table_class</span> <span class="o">=</span> <span class="n">create_table_class</span><span class="p">(</span><span class="n">Table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">table_class</span></div>


<div class="viewcode-block" id="create_table"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.create_table">[docs]</a><span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">table_config</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
    <span class="c1"># Attempt to load from the DB</span>
    <span class="n">table_class</span> <span class="o">=</span> <span class="n">load_table</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_class</span> <span class="ow">and</span> <span class="n">table_config</span><span class="o">.</span><span class="n">create_table_if_missing</span><span class="p">:</span>
        <span class="n">define_table_f</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">table_config</span><span class="o">.</span><span class="n">define_table_f</span> <span class="ow">or</span>
            <span class="n">_get_default_define_f</span><span class="p">(</span>
                <span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">primary_key_column_names</span><span class="o">=</span><span class="n">table_config</span><span class="o">.</span><span class="n">primary_key_column_names</span><span class="p">,</span>
                <span class="n">drivername</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">bind</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">drivername</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">bind</span><span class="p">)</span>
        <span class="n">sqlalchemy_table</span> <span class="o">=</span> <span class="n">define_table_f</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
            <span class="n">table_class</span> <span class="o">=</span> <span class="n">create_table_class</span><span class="p">(</span><span class="n">sqlalchemy_table</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">table_class</span> <span class="o">=</span> <span class="n">load_table</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">table_class</span><span class="p">:</span>
                <span class="c1"># If another worker has already created the table, get ready</span>
                <span class="c1"># for more transactions and carry on</span>
                <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise, raise the exception</span>
                <span class="k">raise</span> <span class="n">e</span>

    <span class="k">return</span> <span class="n">table_class</span></div>


<div class="viewcode-block" id="create_table_class"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.create_table_class">[docs]</a><span class="k">def</span> <span class="nf">create_table_class</span><span class="p">(</span><span class="n">sqlalchemy_table</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">TableClass</span><span class="p">(</span><span class="n">declarative_base</span><span class="p">()):</span>
        <span class="n">__table__</span> <span class="o">=</span> <span class="n">sqlalchemy_table</span>

    <span class="k">return</span> <span class="n">TableClass</span></div>


<span class="k">def</span> <span class="nf">_get_default_define_f</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">primary_key_column_names</span><span class="p">,</span> <span class="n">drivername</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">define_table</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Defines an SqlAlchemy database table and adds it to the specified</span>
<span class="sd">        metadata object.</span>

<span class="sd">        Args:</span>
<span class="sd">            metadata (sqlalchemy.Metadata): database metadata.</span>

<span class="sd">        Returns:</span>
<span class="sd">            sqlalchemy.Table: A database table added to the passed metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">_columns_from_sample_record</span><span class="p">(</span>
            <span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">,</span>
            <span class="n">primary_key_column_names</span><span class="o">=</span><span class="n">primary_key_column_names</span><span class="p">,</span>
            <span class="n">drivername</span><span class="o">=</span><span class="n">drivername</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">define_table</span>


<span class="k">def</span> <span class="nf">_columns_from_sample_record</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">primary_key_column_names</span><span class="p">,</span> <span class="n">drivername</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">primary_key_column_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">primary_key_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Column</span><span class="p">(</span>
                <span class="n">col</span><span class="p">,</span> <span class="n">infer_db_type</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">drivername</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">primary_key_column_names</span>
        <span class="p">]</span>
        <span class="n">other_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">infer_db_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">drivername</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">primary_key_column_names</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pri_col_name</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
        <span class="k">while</span> <span class="n">pri_col_name</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pri_col_name</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span>
        <span class="n">primary_key_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">Column</span><span class="p">(</span><span class="n">pri_col_name</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="n">other_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">infer_db_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">drivername</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">primary_key_columns</span> <span class="o">+</span> <span class="n">other_columns</span>


<div class="viewcode-block" id="create_insert"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.create_insert">[docs]</a><span class="k">def</span> <span class="nf">create_insert</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a statement for inserting the passed record to the passed table.</span>
<span class="sd">    The created statement is not executed by this function.</span>

<span class="sd">    For information on creating insert and update statements Refer to these</span>
<span class="sd">    SqlAlchemy `documentation`_ and `tutorial`_.</span>

<span class="sd">    Args:</span>
<span class="sd">        table (sqlalchemy.sql.schema.Table): database table metadata.</span>
<span class="sd">        record (dict): a data record, corresponding to one row, to be inserted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        sqlalchemy.sql.dml.Insert: a statement for inserting the passed</span>
<span class="sd">        record to the specified table.</span>


<span class="sd">    .. _documentation: https://docs.sqlalchemy.org/en/latest/core/dml.html</span>
<span class="sd">    .. _tutorial: https://docs.sqlalchemy.org/en/latest/core/tutorial.html#insert-expressions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">generic_insert</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">record</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_upsert_postgres"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.create_upsert_postgres">[docs]</a><span class="k">def</span> <span class="nf">create_upsert_postgres</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a statement for inserting the passed record to the passed</span>
<span class="sd">    table; if the record already exists, the existing record will be updated.</span>
<span class="sd">    This uses PostgreSQL `on_conflict_do_update` (hence upsert), and that</span>
<span class="sd">    why the returned statement is just valid for PostgreSQL tables. Refer to</span>
<span class="sd">    this `SqlAlchemy PostgreSQL documentation`_ for more information.</span>

<span class="sd">    The created statement is not executed by this function.</span>

<span class="sd">    Args:</span>
<span class="sd">        table (sqlalchemy.sql.schema.Table): database table metadata.</span>
<span class="sd">        record (dict): a data record, corresponding to one row, to be inserted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        sqlalchemy.sql.dml.Insert: a statement for inserting the passed</span>
<span class="sd">        record to the specified table.</span>

<span class="sd">    .. _SqlAlchemy PostgreSQL documentation:</span>
<span class="sd">       https://docs.sqlalchemy.org/en/latest/dialects/postgresql.html#insert-on-conflict-upsert</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">postgres_insert</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">insert_stmt</span><span class="o">.</span><span class="n">on_conflict_do_update</span><span class="p">(</span>
        <span class="n">index_elements</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">primary_key</span><span class="p">],</span>
        <span class="n">set_</span><span class="o">=</span><span class="n">record</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="create_upsert_mysql"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.create_upsert_mysql">[docs]</a><span class="k">def</span> <span class="nf">create_upsert_mysql</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a statement for inserting the passed record to the passed</span>
<span class="sd">    table; if the record already exists, the existing record will be updated.</span>
<span class="sd">    This uses MySQL `on_duplicate_key_update` (hence upsert), and that</span>
<span class="sd">    why the returned statement is valid only for MySQL tables. Refer to this</span>
<span class="sd">    `SqlAlchemy MySQL documentation`_ for more information.</span>

<span class="sd">    The created statement is not executed by this function.</span>

<span class="sd">    Args:</span>
<span class="sd">        table (sqlalchemy.sql.schema.Table): database table metadata.</span>
<span class="sd">        record (dict): a data record, corresponding to one row, to be inserted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        sqlalchemy.sql.dml.Insert: a statement for inserting the passed</span>
<span class="sd">        record to the specified table.</span>

<span class="sd">    .. _SqlAlchemy MySQL documentation:</span>
<span class="sd">       https://docs.sqlalchemy.org/en/latest/dialects/mysql.html#mysql-inser-on-duplicate-key-update</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">mysql_insert</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">insert_stmt</span><span class="o">.</span><span class="n">on_duplicate_key_update</span><span class="p">(</span><span class="o">**</span><span class="n">record</span><span class="p">)</span></div>
    <span class="c1"># passing dict, i.e. ...update(record), isn&#39;t working</span>


<div class="viewcode-block" id="get_column_names_from_table"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.get_column_names_from_table">[docs]</a><span class="k">def</span> <span class="nf">get_column_names_from_table</span><span class="p">(</span><span class="n">table_class</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_class</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span></div>


<div class="viewcode-block" id="infer_db_type"><a class="viewcode-back" href="../../../beam_nuggets.io.relational_db_api.html#beam_nuggets.io.relational_db_api.infer_db_type">[docs]</a><span class="k">def</span> <span class="nf">infer_db_type</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">drivername</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Infer a database column type for storing values of the same type as the</span>
<span class="sd">    passed variable val in a database identified by drivername.</span>

<span class="sd">    Column types are inferred based on the following mapping:</span>

<span class="sd">    +-----------------------+--------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | Python type           | Column type                                                                                            |</span>
<span class="sd">    +=======================+========================================================================================================+</span>
<span class="sd">    | ``bool``              | ``Boolean``                                                                                            |</span>
<span class="sd">    +-----------------------+--------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ``&lt;number&gt;``          | ``Float`` (All python numbers are mapped to Float columns)                                             |</span>
<span class="sd">    +-----------------------+--------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ``datetime.datetime`` | ``DateTime``                                                                                           |</span>
<span class="sd">    +-----------------------+--------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ``datetime.date``     | ``Date``                                                                                               |</span>
<span class="sd">    +-----------------------+--------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ``&lt;default&gt;``         | ``String`` for PostgreSQL and SQLite and String(:const:`VARCHAR_DEFAULT_COL_SIZE`) for other databases |</span>
<span class="sd">    +-----------------------+--------------------------------------------------------------------------------------------------------+</span>

<span class="sd">    Args:</span>
<span class="sd">        val (object): value used to infer the database column type.</span>
<span class="sd">        drivername: specifies the database type and driver used for</span>
<span class="sd">            connecting to the database (the driver information isn&#39;t used to</span>
<span class="sd">            infer the column type).</span>

<span class="sd">    Returns:</span>
<span class="sd">        object: one of sqlalchemy column types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">is_type_f</span><span class="p">,</span> <span class="n">db_type</span> <span class="ow">in</span> <span class="n">PYTHON_TO_DB_TYPE</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_type_f</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">db_type</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">String</span> <span class="k">if</span> <span class="n">_does_support_varchar</span><span class="p">(</span><span class="n">drivername</span><span class="p">)</span> <span class="k">else</span>
        <span class="n">String</span><span class="p">(</span><span class="n">VARCHAR_DEFAULT_COL_SIZE</span><span class="p">)</span>
        <span class="c1"># It seems only PostgreSQL and SQLite support String columns with</span>
        <span class="c1"># not specified length.</span>
    <span class="p">)</span></div>


<span class="n">VARCHAR_DEFAULT_COL_SIZE</span> <span class="o">=</span> <span class="mi">50</span>


<span class="k">def</span> <span class="nf">_does_support_varchar</span><span class="p">(</span><span class="n">drivername</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;postgresql&#39;</span> <span class="ow">in</span> <span class="n">drivername</span> <span class="ow">or</span> <span class="s1">&#39;sqlite&#39;</span> <span class="ow">in</span> <span class="n">drivername</span>


<span class="k">def</span> <span class="nf">_is_number</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span>


<span class="n">PYTHON_TO_DB_TYPE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Order matters!</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="n">Boolean</span><span class="p">),</span>
    <span class="p">(</span><span class="n">_is_number</span><span class="p">,</span> <span class="n">Float</span><span class="p">),</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">),</span> <span class="n">DateTime</span><span class="p">),</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">),</span> <span class="n">Date</span><span class="p">),</span>
<span class="p">]</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Mohamed Haseeb

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>